#!/usr/bin/env bash

# Update the polling_body in src/settings.yml with the graphql query from queries/query.graphql

# File paths
SETTINGS_FILE="src/settings.yml"
QUERY_FILE="queries/query.graphql"

# Check if files exist
if [[ ! -f "$SETTINGS_FILE" ]]; then
    echo "Error: settings.yml not found at $SETTINGS_FILE"
    exit 1
fi

if [[ ! -f "$QUERY_FILE" ]]; then
    echo "Error: query.graphql not found at $QUERY_FILE"
    exit 1
fi

# Read the graphql query, remove excessive whitespace, escape special characters, and build JSON string
QUERY_CONTENT=$(cat "$QUERY_FILE")

# Remove excessive whitespace: normalize all whitespace sequences to single spaces
# but preserve newlines and basic structure
QUERY_MINIMIZED=$(echo "$QUERY_CONTENT" | sed 's/[[:space:]]\+/ /g' | sed 's/^[[:space:]]*//g' | sed 's/[[:space:]]*$//g' | sed '/^$/d')

# Escape newlines, tabs, quotes, and backslashes for JSON string
QUERY_JSON=$(echo "$QUERY_MINIMIZED" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')

# Build the complete polling_body JSON
POLLING_BODY="{\"query\":\"$QUERY_JSON\", \"variables\": {\"reading_offset\": {{ \"now\" | date: \"%N\" | modulo: 10 }} } }"

# Use temp file for safety
TEMP_FILE=$(mktemp)

# Update settings.yml - use single-quoted string instead of multiline
sed "s/polling_body: .*/polling_body: '$POLLING_BODY'/" "$SETTINGS_FILE" > "$TEMP_FILE"

if [[ $? -eq 0 ]]; then
    mv "$TEMP_FILE" "$SETTINGS_FILE"
    echo "Successfully updated polling_body in $SETTINGS_FILE with query from $QUERY_FILE"
else
    echo "Error: Failed to update settings.yml"
    rm -f "$TEMP_FILE"
    exit 1
fi


